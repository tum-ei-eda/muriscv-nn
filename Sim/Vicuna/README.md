# Vicuna RTL Simulation
Vicuna (https://github.com/vproc/vicuna) is a vector processor that is designed to comply with the Zve32x extension.  

# Simulating Integration Tests
Below are the steps to run three TVM integration tests using Vicuna:
1. Setup the integration tests using the `setup_tvm.sh` script in the `Integration/tvm` directory.
2. Setup Vicuna and Verilator using the `setup.sh` script located in this directory.
3. Build Integration tests using muRISCV-NN with the desired configuration.  For example, create a `build` directory and run: `cmake -DSIMULATOR=Vicuna -DRISCV_GCC_PREFIX=$(pwd)/../Toolchain/rv32imv/ -DENABLE_INTG_TESTS=ON -DTOOLCHAIN=LLVM -DUSE_VEXT=ON ..` and `make aww_tvm` to build the aww integration test for Vicuna.
4. Run the integration test by using the `run.sh` script in this directory.  Provide the path to a file containing the path to the compiled binary as the argument. For example, `./run.sh /../../build/Integration/tvm/aww/aww_tvm.elf.path` (TODO: Vicuna's configuration arguments are hard coded in this script.  Allow the user to adjust these when running our `run.sh` script.)

Running simulations with Vicuna results in the generation of a trace file, trace.csv.  This file can be very large (multiple GBs).  It is generated by the file `Sim/Vicuna/vicuna/sim/verilator_main.cpp`.  Commenting out the `fprintf()` command in the `log_cycle()` function at the bottom of this file prevents the generation of the trace.  If desired, this change could be added to the `muriscv_nn.patch` file.
 


NOTE: Vicuna currently supports two processor cores, Ibex and cv32e40x.  For benchmarking with both cores, M-mode access is required to read the necessary CSRs.  Ibex runs user code in U-Mode, and attempting to raise privilege level using `ecall` results in a jump to address 0x0000, aborting the simulation.  For benchmarking, use the cv32e40x core, as this core only operates in M-Mode.




# Issues:
1. As of now (06/2023) Vicuna is not fully compliant with the Zve32x extension.  Below are the known issues and solutions:

- No support for the vector integer divide functions (vdiv, vdivu, vrem, vremu)
    - Current solution is to use scalar operation for these functions
- No support for any vsext_vf4_XXX or vzext_vf4_XXX functions
    - Current solution is to use two v(s/z)ext_vf2_XXX functions  (see muriscv_nn_support_functions.h)
- No support for the vsext_vf2_i32m8 function
    - Current solution is to use vwadd_vx_i32m8 (see muriscv_nn_support_functions.h)

2. Currently, the output of the integration tests does not match the exepected output when running the integration tests with Vicuna.  This requires more investigation, it may be related to this issue (https://github.com/vproc/vicuna/issues/101).  The changes necessary to resolve Issue 1 pass all unit tests when run using Spike.

3. Currently, only the aww, toycar, and resnet benchmarks can be run (after applying the patch) due to the RAM size specified in the linker scripts.  A configuration may exist that allows for vww to be run, however increasing the size of the RAM too much causes the uart_printf() function used for printing to the console to break. 

